## 2. HTTP

Сеть Интернет представляет собой множество компьютеров, соединенных друг с другом кабелями, а также радиоканалами, спутниковыми каналами и т. д. Однако, как известно, одних проводов или радиоволн для передачи информации недостаточно: передающей и принимающей сторонам необходимо придерживаться ряда соглашений, позволяющих строго регламентировать передачу данных и гарантировать, что эта передача пройдет без искажений. Такой набор правил называется протоколом передачи. Упрощенно, протокол — это набор правил, который позволяет системам, взаимодействующим в рамках сети, обмениваться данными в наиболее удобной для них форме.

Для разных целей обмена данными существуют различные протоколы. В Web-программировании используется протокол TCP (Transmission Control Protocol, протокол управления передачей данных), а точнее, протокол HTTP (Hypertext Transfer Protocol, протокол передачи гипертекста), базирующийся на TCP.

Одной из самых популярных служб Интернета является World Wide Web, WWW или Web (все три термина совершенно равносильны). Большинство серверов Сети поддерживают WWW и связанный с ним протокол передачи HTTP (Hypertext Transfer Protocol, протокол передачи гипертекста).

WWW привлекательна тем, что позволяет организовывать на хостах сайты — хранилища текстовой и любой другой информации, которая может быть просмотрена пользователем в интерактивном режиме.

Вкратце, WWW работает следующим образом:

- браузер пользователя (клиентская сторона) отправляет на сервер запрос с адресом сайта (URL);
- хост (сторона сервера) получает этот запрос и возвращает клиенту запрошенный контент.

Иными словами, весь современный веб построен на модели клиент-серверного взаимодействия.



## 2.1. URL

Каждый Web-сайт обычно хранит в себе множество документов. Следовательно, нужно иметь механизм, который бы позволял пользователю ссылаться на конкретный документ внутри указанного хоста.

Для того, что бы можно было ссылаться на конкретный документ внутри указанного хоста, существует специальный механизм адресации, который называется URL (Universal Resource Locator, универсальный локатор ресурса).

В общем случае URL выглядит примерно так: http://example.com:80/path/to/document.html

Часть URL, предваряющая имя хоста и завершающаяся двумя косыми чертами (в нашем примере http://), указывает браузеру, какой высокоуровневый протокол нужно использовать для обмена данными с Web-сервером. Обычно это HTTP, но могут поддерживаться и другие протоколы (https, ftp и т.д.).

Следом за протоколом идет имя узла, на котором размещается запрашиваемая страница (в нашем примере — example.com). Это может быть не только доменное имя хоста, но и его IP-адрес.

Сразу за именем хоста через двоеточие может следовать (а может и быть опущен) номер порта. Исторически сложилось, что для протокола HTTP стандартный номер порта — 80. Именно это значение используется браузером, если пользователь явно не указал номер порта. Как мы знаем, порт идентифицирует постоянно работающую программу на сервере (или, как ее нередко называют, сетевой демон), в частности, порт 80 связывается с Web-сервером, который и осуществляет обработку HTTP-запросов клиентов и пересылает им нужные документы. Существуют демоны и для других протоколов, например SSH и IMAP, но к ним нельзя подключиться с помощью браузера.

Далее идет последняя часть адресной строки — путь к файлу страницы (в нашем примере это /path/to/document.html). При этом, совершенно не обязательно, чтобы эта страница действительно присутствовала. Вполне типична ситуация, когда страницы создаются "на лету" и не представлены отдельными файлами в файловой системе сервера.



## 2.2. Как работает HTTP, и зачем нам это знать

Что бы успешно программировать на PHP, необходимо понимать, как работает протокол HTTP.

HTTP состоит из двух частей:

- Заголовки запросов и ответов;
- Тела запросов и ответов;

И клиент, и сервер могут посылать друг другу заголовки и тело запроса, однако у клиента заголовки будут одни, а у сервера другие.

Как выглядит процесс запроса страницы, с использованием протокола HTTP:

1. Браузер отправляет на сервер (example.ru) следующий запрос:

```
GET / HTTP/1.1
Host: example.ru
```

2. Сервер принимает данный запрос и отправляет ответ:

```
HTTP/1.1 200 OK
Server: Apache

<html>
<head>
  <title>Example</title>
</head>
<!-- остальная часть страницы -->
```

3. Браузер получает ответ от сервера, и отображает полученный html документ

Остановимся подробнее на первом шаге. Запрос определяет несколько важных параметров, а именно:

- Метод, при помощи которого запрашивается контент (в нашем случае GET)
- Адрес сервера;
- Версия протокола.

`GET` — это метод, с которым мы обращаемся к указанной странице сайта.
Метод `GET`используется чаще всего, т.к. он сообщает серверу о том, что клиенту нужно получить указанный документ. Но помимо `GET` есть и другие методы, каждый из которых сообщает, с какой целью производится запрос к серверу.

Следом за методом указывается адрес документа на сервере. (URI - универсальный идентификатор ресурса). В текущем примере запрашивается главная страница, поэтому в качестве URI указывается косая черта (слэш) - `/`.

В конце строки указывается версия протокола. Зачастую это `HTTP/1.1`.

Далее, в следующих строках перечисляются `заголовки`, передающие серверу дополнительную информацию: язык, параметры браузера, кодировка, настройки кеширования и т.д. В заголовках так же должен содержаться обязательный заголовок `Host`, который указывает домен, запрошенный браузером.

В свою очередь, сервер, приняв запрос, определяет у себя сайт с доменом, указанном в `Host`, а также документ (страница) на сайте, указанный в URI.
В случае успеха, если сайт и страница найдены, клиенту будет отправлен ответ:

```
HTTP/1.1 200 OK
```

Данный ответ говорит о том, что документ определен и отправлен клиенту. Структурированно, стартовая строка ответа выглядит следующим образом:

```
HTTP/Версия Код состояния Пояснение
```

Одним из важных значений в данной строке является код состояния, либо же код ответа от сервера.
В нашем примере, код ответа равен 200. Это значит, что сервер работает, запрошенный документ найден и отправлен клиенту. Однако, бывает, когда запрос-ответ может завершиться неудачей. В таком случае, код ответа будет отличаться от 200, и клиент не получит требуемый контент. Например:

- 404 — сервер доступен, запрошенная страница не найдена;
- 503 — сервер доступен, нет возможности обработать запросы по техническим причинам (например, сервер перегружен).

Существует большой набор кодов состояния. Они сгруппированы в 5 классов:

1. Информационные 100 - 199
2. Успешные 200 - 299
3. Перенаправления 300 - 399
4. Клиентские ошибки 400 - 499
5. Серверные ошибки 500 - 599

После стартовой строки следуют заголовки ответа, а затем тело ответа.



## 2.3. Работа с заголовками в PHP

PHP отлично адаптирован для работы с протоколом HTTP. Он содержит инструменты для получения тела запроса, заголовков, добавления/изменения заголовков ответа, управления телом ответа. Ниже рассмотрим подробнее каждый пункт.

### Получение тела запроса

Тело запроса - это данные, которые браузер отправляет на сервер, во время запроса страницы. Однако тело запроса будет присутствовать только в случае, если страница запрашивается методом `POST`. Данный метод применяется в случае, когда необходимо отправить какие-либо данные на сайт. Зачастую, метод `POST` используется в момент отправки формы. При таком сценарии, телом запроса будет являться содержимое формы.

На стороне сервера, в PHP скриптах, все данные (например данные формы), которые были переданы браузером во время запроса с методом 'POST', будут находиться в массиве `$_POST`

### Получение заголовков запроса

Заголовок запроса - это специальная дополнительная информация, которую отправляет браузер во время запроса страницы. На стороне веб сервера, в PHP сценарии, эти заголовки автоматически извлекаются и помещаются в массив `$_SERVER`. Этот массив, помимо заголовков, так же содержит и другую информацию (пути к скриптам, информация о клиенте и т.д.). Данные о заголовках находятся в ключах массива, начинающихся с `HTTP_`. Полное содержимое массива `$_SERVER` перечислено в [официальной документации](https://www.php.net/manual/ru/reserved.variables.server.php).

Например, адрес предыдущей страницы, с которой перешёл пользователь, хранится в массиве в ключе `HTTP_REFERER`:

```php
print($_SERVER['HTTP_REFERER']);
```

### Добавление/изменение заголовков ответа

Так как PHP работает на стороне веб-сервера, в нём есть возможность модифицировать заголовки ответа, которые будут отправлены пользователю вместе с содержимым страницы.

Примеры, когда может пригодиться управление заголовками ответа:

- Кэширование;
- Переадресация пользователя;
- Установка cookies;
- Отправка файлов;
- Передача дополнительной информации браузеру.

Для манипуляциями с заголовками ответов используется специальная функция `header()`.

Функция header() — предназначена для посылки заголовка браузеру, точнее, для добавления заголовка к документу, пересылаемому браузеру. Она может быть вызвана только до первой команды вывода сценария.

Обычно функция header() является одной из первых команд сценария. Она предназначена для установки заголовков ответа, которые будут переданы браузеру — по одному заголовку на вызов.

Пример:

```php
// Перенаправляет браузер на другой сайт
header("Location: http://php.net");
// Теперь принудительно завершаем сценарий ввиду того, что после
// перенаправления больше делать нечего
exit();
```

Иногда при вызове функции header() вы можете столкнуться со следующим предупреждением PHP:
```
Warning: Cannot modify header information - headers already sent by (output started at badheader.php:2) in badheader.php on line 3 
```
Дело в том, что вызов header() обязательно должен осуществляться до любого оператора вывода в сценарии. Сообщение в примере выше говорит нам, что на строке 2 сценария badheader.php "проскочил" оператор вывода. В строке 3 была вызвана функция header(), которая и рапортует об ошибке.

### Управление телом ответа

Всё, что PHP выводит на экран, является содержимым ответа. Иными словами, вызовы функций `print`, `echo` или показ текста через шорт-теги (`<?= $a; ?>`) являются телом ответа, которое попадает в браузер пользователю.



### Источники
- https://ru.wikipedia.org/
- PHP7. Дмитрий Котеров, Игорь Симдянов