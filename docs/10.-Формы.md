## 10. Формы

Веб формы это специальные конструкции в языке HTML. Формы служат для передачи данных с браузера на сервер. В основном, они используются при авторизации и регистрации пользователей, оформлении заказов в интернет-магазине, заполнении анкет и т.д. Формы позволяют передавать как простую информацию в строковом формате, так и файлы.

При помощи HTML описываются элементы формы и её внешний вид. Однако, для полноценной работы этого недостаточно, на стороне сервера должны быть написаны соответствующие сценарии для обработки данных, которые передаёт браузер через заданную форму.

В PHP имеется множество инструментов для работы с формами. Благодаря этому, есть возможность решать большинство типичных задач, возникающих в веб-программировании:

- Регистрация и аутентификация пользователя;
- Отправка комментариев на форумах и в социальных сетях;
- Оформление заказов.



## 10.1. Отправка формы

Ниже приведен пример формы обратной связи. В таких формах обычно указывается имя, адрес электронной почты и собственно текст сообщения. В HTML форма может быть описана примерно в таком виде:

```html
<form name="feedback" method="POST" action="form.php">
  <label>Имя: <input type="text" name="name"></label>
  <label>Email: <input type="text" name="email"></label>
  <label>Сообщение: <textarea name="message"></textarea></label>

  <input type="submit" name="send" value="Отправить">
</form>
```

В основном, весь приведённый код описывает внешний вид и содержание формы, однако следует обратить внимание на два атрибута тега `<form>`, которые нужны для указания на способ обработки данных:

- `method` — этот атрибут используется для определения метода HTTP, который будет использован для передачи данных на сервер. Ранее мы рассматривали методы HTTP запросов. Метод `GET` служит для получения данных с сервера, в то время как метод `POST` используется в том случае, когда необходимо передать данные на сервер. В приведенном примере как раз необходимо использовать `POST`
- `action` — содержит адрес PHP-скрипта, который должен обработать эту форму.

После нажатия на кнопку «отправить», браузер выполняет POST запрос с введёнными данными. Запрос выполняется по адресу, указанному атрибуте `action`.



## 10.2. Обработка формы

После того, как форма была отправлена, дальнейшая обработка данных производится на стороне сервера в PHP скриптах. Скрипт выполняет какие либо действия (например, сохранение введенных данных в БД, и отправка уведомления администратору сайта) и  показывает результат. В качестве результата обычно выступает какое-либо сообщение о статусе операции. К примеру, это может быть сообщение "Ваши данные успешно отправлены. Спасибо за обращение".

Соответственно, необходимо в первую очередь разобраться, как получать данные из формы в PHP скрипте.
Делается это не сложно: **данные формы, которые были переданы, сохранены в специальном суперглобальном массиве `$_POST`**. Ключи массива соответствуют атрибутам `name` переданных полей, а значения массива в свою очередь соответствуют содержимому переданных полей.

Например, для вывода на экран всей переданной из формы информации, можно использовать следующий php-скрипт:

```php
<?php
if (!empty($_POST)) {
    print("Имя: " . $_POST['name']);
    print("<br>Email: " . $_POST['email']);
    print("<br>Сообщение: " . $_POST['message']);
}
```

Функция `empty` проверяет массив `$_POST`на пустоту. Непустой массив будет означать то, что во время обращения к серверу, был использован метод `POST` и были переданы данные формы.

Обычно, после того, как форма была обработана в PHP, пользователя переадресовывают на другую страницу. Это необходимо для того, что бы при обновлении страницы, запрос на сервер вновь не выполнился с методом `POST` и HTML форма не была отправлена еще раз.



## 10.3. Отправка файлов

Помимо строковых данных, в форме есть возможность отправлять на сервер файлы любых типов.

Пример формы, позволяющей отправить файл:

```html
<form name="file_upload" method="POST" action="form.php" enctype="multipart/form-data">
  <label>Фото: <input type="file" name="photo"></label>
  <input type="submit" name="send" value="Отправить файл">
</form>
```

В отличие от примера с отправкой текстовых данных, в данном примере есть 2 отличия:

- в теге `form` присутствует атрибут `enctype`, который всегда должен иметь значение`multipart/form-data`. Только при наличии этого атрибута файл будет отправлен
- Сам файл загружается в поле с типом «file».

Соответственно, на стороне сервера, в PHP сценарии, загруженный файл будет доступен в другом суперглобальном ассоциативном массиве — `$_FILES`.

```php
<?php
if (!empty($_FILES['photo'])) {
    $file = $_FILES['photo'];

    print("Загружен файл с именем " . $file['name'] . " и размером " . $file['size'] . " байт");
}
```

Стоит иметь ввиду, что PHP автоматически сохраняет все загружаемые файлы в специальную временную папку на сервере. Но, так как эта папка периодически очищается, хранить файлы в ней нельзя. В качестве решения, необходимо перемещать необходимые нам загруженные файлы в другую папку. Обычно это отдельная папка в директории сайта (uploads, media, var и так далее). Перемещение файлов необходимо выполнять сразу после загрузки.

### Перемещение загруженного файла

Что бы переместить файл, необходимо знать, где он находится сейчас, а так же адрес папки, в которую мы собираемся его перенести. Текущий адрес файла сохранен в массиве `$_FILES`. Новый адрес файла, в свою очередь, состоит из пути к нужной нам папки и имени файла. 

Допустим, мы решили сохранять загружаемые файлы в папку `media`. Предположим, что папка `media` расположена там же, где и текущий php-сценарий. В таком случае, адрес папки можно получить при помощи конструкции: `dirname(__FILE__)`.

В таком случае, код для перемещения файла в новую папку будет выглядеть следующим образом:

```php
<?php
$uploaddir = '/var/www/media/';
$uploadfile = $uploaddir . basename($_FILES['photo']['name']);

echo '<pre>';
if (move_uploaded_file($_FILES['photo']['tmp_name'], $uploadfile)) {
    echo "Файл корректен и был успешно загружен.\n";
} else {
    echo "Возможная атака с помощью файловой загрузки!\n";
}

echo 'Некоторая отладочная информация:';
print_r($_FILES);

print "</pre>";

```

Функция `move_uploaded_file()` выполняет два действия:

1. Проверяет, что файл действительно загружен через форму.
2. Перемещает загруженный файл по новому адресу.



## 10.4. Валидация формы

Валидация формы - проверка веб-приложением вводимых в форму данных. Если данные верны, приложение позволяет отправить эти данные на сервер и обработать их соответствующим образом (например, сохранить в БД). Примерами валидации могут являться:

- проверка обязательности заполнения какого-либо поля
- проверка длины введенных данных (к примеру минимальная длина пароля - 10 символов)
- проверка соответствия введенных данных определенному формату (например поле для ввода email адреса)

Так же, помимо строковых данных, вводимых в форме, можно проверять формат и размер загружаемых файлов.

​	

## 10.5. Уязвимости

Так как динамические сайты работают с данными, которые передают пользователи, есть большая вероятность использования предоставляемых возможностей не по назначению. К примеру, формы получения обратной связи могут быть использованы не для передачи отзывов, а для взлома сайта, либо заражения вредоносным программным обеспечением.

### Фильтрация данных

К примеру есть сайт-форум. Такой сайт в основном состоит из контента, загружаемого пользователями. Соответственно, всю информацию, которую сайт получает от пользователей, необходимо фильтровать, прежде чем сохранять и в дальнейшем отображать на страницах. Процесс фильтрации, это применение к загружаемой информации набора правил, которые позволяют очистить её и подготовить к публикации на сайте. Одна из уязвимостей, которую способно исключить фильтрование, называется `XSS-уязвимость`.

### XSS-уязвимость

XSS (cross-site scripting, межсайтовое исполнение сценариев) — это уязвимость, которая позволяет внедрять на выдаваемую страницу вредоносный JavaScript - код. Это возможно при отсутствии, или недостаточной фильтрации информации, полученной от пользователя.

### Общий принцип атаки

1. На сайте имеется форма обратной связи
2. Через эту форму злоумышленник вместо текста-отзыва отправляет JS-код.
3. Сообщение сохраняется в БД и публикуется на странице отзывов, которая доступна всем пользователям сайта.
4. Вредоносный JS-код выполняется для каждого пользователя, который посетил страницу отзывов.
5. Выполняясь, вредоносный код наносит вред посетителям сайта, например крадёт их cookie-файлы.

### Замена опасных символов

Возможное решение - замена потенциально опасных символов. Необходимо заменить символы таким образом, что бы полученная информация была безопасна, однако при этом необходимо сохранить всю информацию, не потеряв её часть. Для этого существуют так называемые `HTML -мнемоники`.
**Мнемоника** — это специальная конструкция, которая ссылается на символ в HTML. Мнемоника начинается со знака амперсанда «&» и завершается точкой с запятой «;».

К примеру, что бы сохранить и в дальнейшем отобразить теги `<script>`, необходимо треугольные скобки тега заменить на мнемоники. Такой текст не будет трактоваться браузером как HTML - код. Мнемоники часто используют для показа пользователю фрагментов HTML - кода. Проинспектировав (F12) исходный код такого фрагмента, можно увидеть, что вместо кавычек и скобок, в фрагменте используются мнемоники. 

Так же, никто не запрещает попросту вырезать все теги из текста. 

### Функция фильтрации htmlspecialchars

Что бы не выполнять вручную все замены опасных символов на мнемоники, В PHP есть специальная функция `htmlspecialchars`, которая выполняет фильтрацию для заданной строки.  

Пример работы:

```php
<?php
$text = "<script><script>"; // строка от пользователя
$safe_str = htmlspecialchars($text); // отфильтрованная строка

print($safe_str); // узнаём, что получилось
```

Результат работы этого сценария: `&lt;script&gt;&lt;/script&gt;`

Рекомендуется всегда использовать данную функцию при отображении информации от пользователей.



### Источники
- [https://www.php.net/](https://www.php.net/)