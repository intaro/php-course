## 12. Типы ошибок и исключения

## 12.1. Ошибки

Термин "ошибка" имеет три различных значений. 

1. Ошибочная ситуация — непосредственно факт наличия ошибки в программе. Это может быть, например, синтаксическая ошибка (скажем, пропущенная скобка) или же ошибка семантическая — смысловая (использование переменной, которая ранее не была определена). 
2. Внутреннее сообщение об ошибке ("внутренняя ошибка"), которую выдает PHP в ответ на различные неверные действия программы (например, открытие несуществующего файла). 
3. Пользовательское сообщение об ошибке ("пользовательская ошибка"), к которой причисляются все сообщения или состояния, генерируемые и обрабатываемые самой программой. Например, в скрипте авторизации ситуация "введен неверный пароль" — ошибка именно такого рода.

### Все ошибки, условно, можно разбить на категории по нескольким критериям.

Фатальность:

- Фатальные
  Неустранимые ошибки. Работа скрипта прекращается.
  `E_ERROR`, `E_PARSE`, `E_CORE_ERROR`, `E_COMPILE_ERROR`.
- Не фатальные
  Устранимые ошибки. Работа скрипта не прекращается.
  `E_WARNING`, `E_NOTICE`, `E_CORE_WARNING`, `E_COMPILE_WARNING`, `E_USER_WARNING`, `E_USER_NOTICE`, `E_STRICT`, `E_DEPRECATED`, `E_USER_DEPRECATED`.
- Смешанные
  Фатальные, но только, если не обработаны функцией, определенной пользователем в `set_error_handler()`.
  `E_USER_ERROR`, `E_RECOVERABLE_ERROR`.


Возможность перехвата ошибки функцией, определенной в `set_error_handler()`:

- Перехватываемые (не фатальные и смешанные)
  `E_USER_ERROR`, `E_RECOVERABLE_ERROR`, `E_WARNING`, `E_NOTICE`, `E_USER_WARNING`, `E_USER_NOTICE`, `E_STRICT`, `E_DEPRECATED`, `E_USER_DEPRECATED`.
- Не перехватываемые (фатальные)
  `E_ERROR`, `E_PARSE`, `E_CORE_ERROR`, `E_CORE_WARNING`, `E_COMPILE_ERROR`, `E_COMPILE_WARNING`.


Инициатор:

- Инициированы пользователем
  `E_USER_ERROR`, `E_USER_WARNING`, `E_USER_NOTICE`.
- Инициированы PHP
  `E_ERROR`, `E_PARSE`, `E_CORE_ERROR`, `E_COMPILE_ERROR`, `E_WARNING`, `E_NOTICE`, `E_CORE_WARNING`, `E_COMPILE_WARNING`, `E_STRICT`, `E_DEPRECATED`, `E_USER_DEPRECATED`, `E_USER_ERROR`, `E_RECOVERABLE_ERROR`.



## 12.1. Исключения 

### Что такое исключения?

Исключения являются специальными условиями, обычно в случае ошибки, которые проявляются или могут быть специально созданы программой. Они указывают на то, что что-то в процессе отличается от предполагаемого хода событий. В большинстве случаев подобные ситуации требуют выполнения специальных инструкций, чтобы предотвратить неконтролируемое завершение процесса.


### Как работают исключения?

Исключения могут быть брошены (`thrown`) и пойманы (`caught`). Когда исключение брошено, то значит, произошло что-то выходящее за рамки нормального течения процесса работы программы, и требуется выполнение какой-то другой функции. Подхват исключения осуществляется в специальной функции, которая сообщает остальной программе о том, что она готова обработать исключение.

Для объяснения действия исключений очень хорошо подходит аналогия с бейсболом.

- Питчер (браузер) бросает мяч кетчеру.
- Отбивающий игрок пытается попасть по мячу. Если ему не удается отбить мяч, то он получает страйк. А если удается, то полевой игрок может поймать мяч.
- Если полевой игрок ловит мяч, у него есть два варианта действий. Если он достаточно далеко от отбивающего, то может передать мяч другому полевому игроку. А если до отбивающего небольшое расстояние, то полевой игрок может кинуть мяч в него и тем самым вывести его из игры.

Бросок питчера кэтчеру в модели исключения похож на нормальное течение процесса. Но если отбивающий игрок попадет по мячу, происходит исключительная ситуация.

Ловля мяча полевым игроком похожа на выполнение функции `try-catch `для обработки исключения. Функция `try-catch ` может самостоятельно выполнить нужные действия, или перебросить исключение другой функции.


### Как использовать исключения

Сформировать обработку исключений в PHP очень просто. Так как исключения являются частью [стандартной библиотеки PHP](http://php.net/manual/en/book.spl.php) (SPL), они входят в ядро PHP, начиная с версии 5. То есть исключения уже ждут, когда их начнут использовать.

Исключения реализуются также как и любой другой объект:

```php
$exception = new Exception();
throw $exception;
```

Так же как и любой объект, они имеют методы, которые можно вызвать. Данные методы облегчают формирование реакции на исключение. Например, функция `getMessage()` позволяет получить сообщение об ошибке, которое может быть записано в журнал или выведено в браузер.

Вот список методов исключений:

- `getMessage()` – получает сообщение исключения;
- `getCode()` – возвращает числовой код, который представляет исключение;
- `getFile()` – возвращает файл, в котором произошло исключение;
- `getLine()` – возвращает номер строки в файле, где произошло исключение;
- `getTrace()` – возвращает массив *backtrace()* до возникновения исключения;
- `getPrevious()` – возвращает исключение, произошедшее перед текущим, если оно было;
- `getTraceAsString()` – возвращает массив *backtrace()* исключения в виде строки;
- `__toString()` –возвращает все исключение в виде строки. Данную функцию можно переписать.

К примеру попробуем создать пользователя с неправильным идентификатором:

```php
//Сначала создаем пользователя с номером один
$user = new User(1);

//Затем намеренно делаем ошибку
$user2 = new User('not numeric');
```

В итоге мы получим системное сообщение об ошибке.

А теперь поймаем возникающее исключение и обработаем его:

```php
try {
   //Сначала создаем пользователя с номером один
   $user = new User(1);

   //Затем намеренно делаем ошибку
   $user2 = new User('not numeric');
} catch( Exception $e ) {
   echo "Полевой игрок поймал исключение: {$e->getMessage()}";
}
```

То есть, когда мы ловим исключение, то можно избежать ужасного сообщения об ошибке, формируемого PHP по умолчанию.

Нужно помнить, что когда появляется исключение, оно останавливается только в том случае, если функция `try-catch` может его поймать. Иначе оно остается не пойманным и будет карабкаться по стеку вызовов, что в конечном итоге приведет к выводу сообщения об ошибке в браузере.

### Источники

- PHP7. Дмитрий Котеров, Игорь Симдянов